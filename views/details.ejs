<% layout('/layouts/boilerplate') %>

<nav class="navbar padding navbar-expand-lg fw-bolder lead">
  <div class="container-fluid">

      <a href="/homePage" class="navbar-brand fw-bold mx-3 ">Oktub</a>
      
      <div class="d-flex align-items-baseline">
        
          <div id="profile-links-btn2" class="position-relative   d-block d-md-none ">
              <% if(currentUser){ %>
              <a href="#"
                  id="dropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"
                  class="outline-none dropdown-toggle dropdown-toggle-split text-decoration-none"><img
                      width="50"
                      src="<%= currentUser.image %> "
                      alt="sham sham" class="rounded-circle outline-none"></a>
             
                  <div id="profile-links2" class="dropdown-menu position-absolute m-1 start-0 end-0"><a
                          href="/username=<%= currentUser.username  %> " class="dropdown-item px-3 p-0 py-1 fw-bold ">My Blogs </a> <a
                          href="/likes" class="dropdown-item px-3 p-0 py-1 fw-bold ">Favorites</a> <a
                          href="/settings" class="dropdown-item px-3 p-0 py-1 fw-bold ">Settings</a>
                      <a href="/statistics"
                          class="dropdown-item px-3 p-0 py-1 fw-bold ">Statistics</a>
                      <a href="/logout" class="dropdown-item px-3 p-0 py-1 fw-bold">
                          Logout
                      </a>
                      <div class="border-bottom flex-1 my-2"></div> <a t arget="_blank" href="/"
                          class="nav-link fw-bold px-3 p-0 py-1 text-secondary">
                       About Oktub
                      </a> <a target=""
                          href=""
                          class="nav-link  fw-bold px-3 p-0 py-1 text-secondary">
                          Writing Conditions 
                      </a> <a target=""
                          href=""
                          class="nav-link fw-bold px-3 p-0 py-1 text-secondary">
                          privacy policy
                      </a>
                  </div>
                  <% } %>
          </div><a href="/create"
              class="btn btn-primary text-white  m-sm-0 px-4 d-block d-md-none  fw-bold">
             new blog
          </a>
      </div>
      <button class="navbar-toggler " type="button" data-bs-toggle="collapse"
          data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
          aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarSupportedContent">
          

        <form class="d-flex justify-content-center align-items-center me-auto p-2 d-none d-md-flex"
        role="search" method="POST"  action="/search">
        <i role="button" id="search-btn"
            class="fa fa-search text-secondary mx-1 fw-bold d-sm-none d-md-block pe-auto"></i>
        <input class="form-control pl-2 pr-2 pb-2  border-secondary focus d-none " id="search-input"
            type="search" name="search" placeholder=" " aria-label="Search">
    </form>


          
          <a href="/blogs/create"
              class="btn btn-primary text-white mb-3 m-sm-0 px-4 d-none d-md-block fw-bold ">
             new blog
          </a> <a href="/"
              class="btn bg-white  shadow-sm text-black px-4 mx-3   fw-blod  d-none d-md-block ">

              explore
          </a>
      </div>
      <% if(currentUser){ %>
          <div id="profile-links-btn" class="position-relative d-none d-lg-block  d-sm-none d-md-block"><a
                  href="#" id="dropdown-menu-links" data-toggle="dropdown" aria-haspopup="true"
                  aria-expanded="false"
                  class="outline-none dropdown-toggle dropdown-toggle-split text-decoration-none"><img
                      width="50"
                      src="<%= currentUser.image %> "
                      alt="sham sham" class="rounded-circle outline-none"></a>
              <div id="profile-links" class="dropdown-menu position-absolute m-1 end-0 "><a
                      href="/username=<%= currentUser.username %> " class="dropdown-item px-3 p-0 py-1 fw-bold ">My Blogs</a> <a
                      href="/likes" class="dropdown-item px-3 p-0 py-1 fw-bold ">Favorites</a> <a href="/settings"
                      class="dropdown-item px-3 p-0 py-1 fw-bold ">Settings</a>
                  <a href="/statistics"
                      class="dropdown-item px-3 p-0 py-1 fw-bold ">Statistics</a>
                  <a href="/logout" class="dropdown-item px-3 p-0 py-1 fw-bold">
                     Logout
                  </a>
                  <div class="border-bottom flex-1 my-2 "></div> <a target=""
                      href=""
                      class="nav-link fw-bold px-3 p-0 py-1 text-secondary">
                     About Oktub
                  </a> <a target=""
                      href=""
                      class="nav-link fw-bold px-3 p-0 py-1 text-secondary">
                    Writing Conditions
                  </a> <a target=""
                      href=""
                      class="nav-link fw-bold px-3 p-0 py-1 text-secondary">
                     Privacy Policy
                  </a>
              </div>
          </div>
          <script type="text/javascript" src="../../public/js/nav.js"></script>
          <% } %>

  </div>
</nav>
  <div class="container lead">
    
    <div class="row">
      <div class="col-lg-10 mx-auto my-5">
        <div class="bg-white shadow rounded-4 mx-auto mb-4 mb-sm-0 p-3 p-sm-5 rounded-lg text-justify">

          <div class="d-block  media media-hover  font-droid align-items-center ">
           
              <h3 class="h3 h-sm-5 mt-0 mb-5 fw-bold text-break">
                <%= blog.title %>
              </h3>

              <p id="p1" class="d-none d-sm-block  text-break fs-4">
                <%= blog.body %> 
              </p>
             
         

          </div>
          <div class="d-flex flex-column flex-sm-row mt-2 border-bottom align-items-baseline">
            <div class="d-flex mb-3 mb-sm-4">
               <span  class="ms-2 mb-0 fw-bold">
                  <span id="likesNum"><%= blog.likes.length %></span>
                  <div class="like_box">
                    <a href="#" class="counter" >k</a><p class="vote_text"><%= blog.likes.length %></p>
                   
          </div>
                  <form action="/blogs/<%=blog.slug %>/like" id="likeForm" method="post" class="d-inline ms-3">
                    <button type="submit" class="btn f p-0 font-14px   ms-sm-auto mt-4 my-sm-2 text-secondary bg-white">
                      <i aria-hidden="true" class="fa fa-heart fs-5"></i></button>
                      <a href="#"
                  class="text-secondary px-2 ms-2">
                  <i aria-hidden="true" class="fa fa-facebook fs-5 mt-5"></i></a> 
                  <a href="#"
                  class="text-secondary px-2"><i aria-hidden="true" class="fa fa-twitter fs-5"></i></a>
                  </form>
                </span> 
                
                
                
            </div>
            <div class="d-flex ms-sm-auto text-center fw-bold mb-4 fs-5">
              <p class="me-2 mb-0">
               published in: 
              </p>
              <p class="mb-0 text-secondary">
                <time>
                  <%= moment(blog.createdAt).format('DD/MM/YYYY'); %>
                </time>
              </p>
            </div>
          </div>
          <div class="d-flex flex-column flex-sm-row align-items-center mt-4 justify-content-between"><a
              href="/username=<%= blog.username  %>" class="text-black text-hover-black text-decoration-none">
              <div class="d-flex align-items-center"><span class="me-3 text-secondary fw-bold">
                  written by: 
                </span> <img width="50" src="<%= profileUser.image %>"
                  alt="Nouf Khalid" class="rounded-circle">
                <div class="ms-3">
                  <p class="mb-0 fw-bold">
                    <% if(blog.username) %>
                      <%= blog.username %>
                  </p>

                  <p class="mb-0 text-secondary"> <%= profileUser.bio %> 
                  </p>
                </div>
              </div>
            </a>
            <% if(currentUser && currentUser.id==blog.user){ %>
              <a href="/blogs/<%=blog.slug %>/edit"
                class="btn f px-4 font-14px px-4  ms-sm-auto mt-4 my-sm-2 btn-primary text-primary bg-white"><span
                  class="fw-bold"><i aria-hidden="true" class="fa fa-plus"></i>
                  Edit
                </span></a>

              <% }else{ %>
                <form action="/blogs/<%=blog.username %>/follow" id="followForm" method="post">
                  <button type="submit" class="btn f px-4 font-14px px-4  ms-sm-auto mt-4 my-sm-2 btn-primary text-primary bg-white">
                    <span class="fw-bold">
                      <i aria-hidden="true" class="fa fa-plus"></i>
                    
                     <% if(currentUser && currentUser.following.includes(profileUser._id)) { %> 
                      unfollow the author 
                      <% }else { %> 
                        follow the author 
                  <% } %>  
                    </span></button>
                </form>
                <% } %>

          </div>

        </div>

        <div class="mt-5">
          <p class="text-secondary fw-bold">latest blogs  </p> 

          
                <% if (blogs.length> 0) { %>
                    <% blogs.forEach(latestBlog=> { %>
                      <% if(blog.slug==latestBlog.slug){}else { %> 
                        <div
                            class="media-hover mx-auto media media-hover mb-4 mb-sm-0 p-3 p-sm-5 rounded-lg font-droid align-items-center">
                            <a class="text-decoration-none text-black" href="/blogs/post=<%= latestBlog.slug %>">
                                <h3 class="h3 h-sm-5 mt-0 mb-4 fw-bold text-break">
                                    <%= latestBlog.title %>
                                </h3>

                                <p class="d-none d-sm-block text-break fw-normal fs-4">
                                    <%= latestBlog.body.slice(0, 200) %>...
                                </p>
                            </a>

                            <a href="<%= latestBlog.username  %> " class="text-decoration-none text-black text-hover-black">
                                <div class="d-flex align-items-center">
                                    <img width="45" src="<%= latestBlog.userImage %> " alt="Nouf Khalid"
                                        class="rounded-circle">
                                    <div class="mx-3">
                                        <p class="mb-0 fw-bold">
                                            <%= latestBlog.username %>
                                        </p>
                                        <p class="mb-0 text-secondary fw-bold">
                                            <time>
                                                <%= moment(latestBlog.createdAt).fromNow(); %>
                                            </time>
                                        </p>
                                    </div>
                                </div>
                            </a>
                        </div>




                        <%} }) %>
                            <% } %>
                                    

          
      </div>
    </div>
  </div>
  <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.7/quill.js"></script>



  <script src="https://code.jquery.com/jquery-3.6.1.js"
  integrity="sha256-3zlB5s2uwoUzrXK3BT7AX3FyvojsraNFxCc2vC/7pNI="
  crossorigin="anonymous"></script>
  <script>

    /* var p1 = document.getElementById('p1');
    p1.innerHTML=quill.setContents(blog.body)
    console.log(p1)
    console.log(blog.body)
     */



    var form = document.getElementById('likeForm');
    var form2 = document.getElementById('followForm');
    var likesNum = document.getElementById('likesNum');
    //console.log(form2)
    if(form2){
     form2.addEventListener("submit",async(e)=>{
        e.preventDefault();
        const formData = new FormData();
        await fetch('/blogs/<%= blog.username %>/follow', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
    }).then()       
    }) }
    
    $(".like_box a").click(async function(event){
        event.preventDefault();
      await  $.ajax({
          method : "POST",
    url: '/blogs/<%= blog.slug %>/like', 
    success: function(result){
            // update $like_num and $like_username here
            // if you do not have them binded use this
          
        }});
    });
     /* form.addEventListener("submit", async(e)=>{
        e.preventDefault();
        
       await fetch('/blogs/<%= blog.slug %>/like', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
    }).then().then(data =>{
      likesNum.innerHTML='<%= blog.likes.length%>';
    })
    })  */
    </script>

  <!-- <form action="/blogs/<%=blog._id %>?_method=DELETE" method="POST">
    <button class="delete">Delete</button>
  </form> -->